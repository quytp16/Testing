<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Tickets</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,sans-serif;max-width:1000px;margin:20px auto;padding:0 16px;color:#0f172a}
    .row{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-bottom:10px;background:#fff}
    .muted{color:#6b7280}
    .btn{background:#0ea5e9;color:#fff;border:0;border-radius:8px;padding:6px 10px;cursor:pointer}
    select{padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px}
  </style>
</head>
<body>
  <h1>Quản trị Tickets</h1>
  <p class="muted">Đăng nhập bằng tài khoản admin (UID phải có tài liệu trong <code>roles/admins/&lt;UID&gt;</code>).</p>
  <div id="adminInfo" class="muted">Đang tải...</div>
  <div id="list"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-A0omawXnKjVdq_4ea3UWjJhAEpx-tSg",
      authDomain: "tuananh-3b562.firebaseapp.com",
      projectId: "tuananh-3b562",
      storageBucket: "tuananh-3b562.firebasestorage.app",
      messagingSenderId: "503117226992",
      appId: "1:503117226992:web:d4d90849149a39182b3335",
      measurementId: "G-P2DEDDNFH4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s => document.querySelector(s);
    const list = $('#list'), info = $('#adminInfo');

    function renderTicket(id, t){
      const el = document.createElement('div');
      el.className = 'row';
      el.innerHTML = `
        <div><strong>${t.subject}</strong> <span class="muted">(${t.status||'open'})</span></div>
        <div class="muted">${t.email || ''} — ${t.userId || ''}</div>
        <div style="margin-top:6px">${t.message}</div>
        <div style="margin-top:8px">
          <select id="sel-${id}">
            <option ${t.status==='open'?'selected':''}>open</option>
            <option ${t.status==='processing'?'selected':''}>processing</option>
            <option ${t.status==='closed'?'selected':''}>closed</option>
          </select>
          <button class="btn" id="btn-${id}">Cập nhật</button>
        </div>`;
      el.querySelector('#btn-'+id).addEventListener('click', async ()=>{
        const v = el.querySelector('#sel-'+id).value;
        await updateDoc(doc(db,'tickets', id), { status: v });
        alert('Đã cập nhật trạng thái: '+v);
      });
      return el;
    }

    onAuthStateChanged(auth, (user)=>{
      if (!user){
        info.textContent = 'Chưa đăng nhập.';
      } else {
        info.textContent = 'Đang tải tickets...';
        const q = query(collection(db,'tickets'), orderBy('createdAt','desc'));
        onSnapshot(q, (snap)=>{
          list.innerHTML = '';
          if (snap.empty){ list.innerHTML = '<div class="muted">Chưa có ticket.</div>'; return; }
          snap.forEach(d=> list.appendChild(renderTicket(d.id, d.data())));
        });
      }
    });
  </script>
</body>
</html>